<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <title>Evidencija hladnjaka</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="mb-4">Evidencija hladnjaka</h1>

        <!-- Forma za unos -->
        <form id="forma-namirnica" class="row g-3 mb-4">
            <div class="col-md-3">
                <input type="text" class="form-control" id="naziv" placeholder="Naziv" required>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" id="kategorija" placeholder="Kategorija" required>
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control" id="kolicina" placeholder="Količina" required>
            </div>
            <div class="col-md-3">
                <input type="date" class="form-control" id="rok_trajanja" required>
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-primary">Dodaj</button>
            </div>
        </form>

        <!-- Tablica namirnica -->
        <h2>Popis namirnica</h2>
        <table class="table table-striped" id="tablica-namirnica">
            <thead>
                <tr>
                    <th>Naziv</th>
                    <th>Kategorija</th>
                    <th>Količina</th>
                    <th>Rok trajanja</th>
                    <th>Akcije</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- Grafikon -->
        <h2>Vizualizacija</h2>
        <canvas id="grafikon" height="100"></canvas>
    </div>

    <script>
    async function ucitajNamirnice() {
        const res = await fetch('/api/namirnice');
        const data = await res.json();
        const tbody = document.querySelector("#tablica-namirnica tbody");
        tbody.innerHTML = "";
        let kategorije = {};
        data.forEach(n => {
            const row = `<tr>
                <td>${n.naziv}</td>
                <td>${n.kategorija}</td>
                <td>${n.kolicina}</td>
                <td>${n.rok_trajanja}</td>
                <td><button class="btn btn-sm btn-danger" onclick="obrisiNamirnicu(${n.id})">Izbriši</button></td>
            </tr>`;
            tbody.innerHTML += row;
            kategorije[n.kategorija] = (kategorije[n.kategorija] || 0) + n.kolicina;
        });
        iscrtajGraf(kategorije);
    }

    async function dodajNamirnicu(e) {
        e.preventDefault();
        const naziv = document.getElementById("naziv").value;
        const kategorija = document.getElementById("kategorija").value;
        const kolicina = document.getElementById("kolicina").value;
        const rok = document.getElementById("rok_trajanja").value;
        await fetch('/api/namirnice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ naziv, kategorija, kolicina, rok_trajanja: rok })
        });
        document.getElementById("forma-namirnica").reset();
        ucitajNamirnice();
    }

    async function obrisiNamirnicu(id) {
        await fetch('/api/namirnice/' + id, { method: 'DELETE' });
        ucitajNamirnice();
    }

    let chart = null;

function iscrtajGraf(kategorije) {
    const ctx = document.getElementById('grafikon').getContext('2d');
    if (chart) {
        chart.destroy(); // brišemo stari graf
    }
    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(kategorije),
            datasets: [{
                label: 'Količina po kategorijama',
                data: Object.values(kategorije),
                backgroundColor: 'rgba(54, 162, 235, 0.6)'
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

    document.getElementById("forma-namirnica").addEventListener("submit", dodajNamirnicu);
    ucitajNamirnice();
    </script>
</body>
</html>
